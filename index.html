<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2-Stock RAG Screener (Alpha Vantage)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --border: rgba(255,255,255,0.08);
      --green: #16a34a;
      --amber: #f59e0b;
      --red: #ef4444;
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 13px; line-height: 1.4; }
    .bar { display: flex; gap: 10px; flex-wrap: wrap; margin: 16px 0 10px; }
    input {
      background: #0f172a; border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; outline: none; font-size: 14px; width: 160px;
    }
    button {
      background: #2563eb; border: none; color: white; padding: 10px 14px; border-radius: 10px;
      cursor: pointer; font-weight: 600;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status { margin: 10px 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .ticker { font-size: 18px; font-weight: 700; }
    .badge { font-size: 12px; padding: 4px 10px; border-radius: 999px; color: white; font-weight: 700; }
    .green { background: var(--green); }
    .amber { background: var(--amber); }
    .red { background: var(--red); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    th { color: var(--muted); font-size: 12px; font-weight: 600; }
    td { font-size: 13px; }
    .k { color: var(--muted); font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .full { grid-column: 1 / -1; }
    .warn { background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.25); padding: 10px 12px; border-radius: 12px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } input { width: 100%; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>2-Stock RAG Screener (Alpha Vantage)</h1>
    <div class="muted">
      Enter two tickers (e.g., <span class="mono">TSLA</span>, <span class="mono">MSFT</span>) → press Scrape.
      Uses Alpha Vantage <span class="mono">OVERVIEW</span>, <span class="mono">INCOME_STATEMENT</span>, <span class="mono">BALANCE_SHEET</span>, <span class="mono">CASH_FLOW</span>.
      <br/>
      <strong>Note:</strong> Alpha Vantage free tier has a daily request limit (25/day). Cache is enabled to reduce repeat calls.
    </div>

    <div class="bar">
      <input id="t1" placeholder="Ticker 1 (e.g., TSLA)" value="TSLA" />
      <input id="t2" placeholder="Ticker 2 (e.g., MSFT)" value="MSFT" />
      <button id="go">Scrape</button>
    </div>

    <div id="status" class="status muted"></div>

    <div id="out" class="grid"></div>

    <div class="warn muted" style="margin-top:14px;">
      <strong>Formula notes:</strong><br/>
      ROIC ≈ <span class="mono">NOPAT / InvestedCapital</span>, where <span class="mono">NOPAT = EBIT_TTM × (1 − tax rate)</span> and
      <span class="mono">InvestedCapital ≈ Equity + TotalDebt − Cash</span>.
      FCF margin uses <span class="mono">(OperatingCashFlow − CapEx)</span> over revenue (TTM).
      NetDebt/EBITDA uses (TotalDebt − Cash) / EBITDA (TTM).
      PEG comes from Alpha Vantage Overview.
    </div>
  </div>

<script>
const API_KEY = "ZMIXYXAQEYNHFFTG";
const BASE = "https://www.alphavantage.co/query";

const THRESHOLDS = {
  roic: { green: 12, amber: 8 },
  fcfMargin: { green: 8, amber: 3 },
  netDebtEbitda: { green: 2, amber: 3 },
  revCagr: { green: 8, amber: 4 },
  peg: { green: 1.5, amber: 2.0 }
};

let lastCallAt = 0;
const MIN_GAP_MS = 13000;
const CACHE_TTL_MS = 6 * 60 * 60 * 1000;

const $ = (id) => document.getElementById(id);
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function fmtNum(x, d=2){ if(x==null||!isFinite(x))return "N/A"; return Number(x).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
function fmtMoney(x){ if(x==null||!isFinite(x))return "N/A"; const n=Math.abs(x); const s=x<0?"-":""; if(n>=1e12)return s+(n/1e12).toFixed(2)+"T"; if(n>=1e9)return s+(n/1e9).toFixed(2)+"B"; if(n>=1e6)return s+(n/1e6).toFixed(2)+"M"; return s+n.toFixed(0); }
function parseAV(v){ if(v==null)return null; const n=Number(v); return isFinite(n)?n:null; }
function ragHigher(v,t){ if(v==null)return{cls:"amber",label:"N/A"}; if(v>=t.green)return{cls:"green",label:"Green"}; if(v>=t.amber)return{cls:"amber",label:"Amber"}; return{cls:"red",label:"Red"}; }
function ragLower(v,t){ if(v==null)return{cls:"amber",label:"N/A"}; if(v<=t.green)return{cls:"green",label:"Green"}; if(v<=t.amber)return{cls:"amber",label:"Amber"}; return{cls:"red",label:"Red"}; }
function score(cls){ return cls==="green"?20:cls==="amber"?10:0; }
function ckey(fn,s){ return `av_cache_v1:${fn}:${s}`; }
function readCache(fn,s){ try{ const r=localStorage.getItem(ckey(fn,s)); if(!r)return null; const o=JSON.parse(r); if(Date.now()-o.savedAt>CACHE_TTL_MS)return null; return o.data; }catch{return null;} }
function writeCache(fn,s,d){ try{ localStorage.setItem(ckey(fn,s),JSON.stringify({savedAt:Date.now(),data:d})); }catch{} }
async function throttled(url){ const w=Math.max(0,(lastCallAt+MIN_GAP_MS)-Date.now()); if(w)await sleep(w); lastCallAt=Date.now(); const r=await fetch(url); const j=await r.json(); if(j.Note||j.Information||j.Error_Message) throw new Error(j.Note||j.Information||j.Error_Message); return j; }
function avUrl(fn,s){ const u=new URL(BASE); u.searchParams.set("function",fn); u.searchParams.set("symbol",s); u.searchParams.set("apikey",API_KEY); return u.toString(); }
async function getAV(fn,s){ const c=readCache(fn,s); if(c)return c; const d=await throttled(avUrl(fn,s)); writeCache(fn,s,d); return d; }
async function fetchPack(s){ const [o,i,b,c]=await Promise.all([getAV("OVERVIEW",s),getAV("INCOME_STATEMENT",s),getAV("BALANCE_SHEET",s),getAV("CASH_FLOW",s)]); return{symbol:s,overview:o,income:i,balance:b,cash:c}; }

function sumQ(arr,f,n=4){ if(!arr||!arr.length)return null; let s=0,k=0; for(const r of arr.slice(0,n)){ const v=parseAV(r?.[f]); if(v!=null){s+=v;k++;}} return k? s:null; }
function annual(arr,f){ return arr?.[0]? parseAV(arr[0][f]):null; }
function revCagr3Y(income){ const a=income?.annualReports; if(!a||a.length<4)return null; const r0=parseAV(a[0].totalRevenue), r3=parseAV(a[3].totalRevenue); if(!r0||!r3||r3<=0)return null; return (Math.pow(r0/r3,1/3)-1)*100; }
function effTax(income){ const a=income?.annualReports; if(!a||!a.length)return 0.21; const t=parseAV(a[0].incomeTaxExpense), p=parseAV(a[0].incomeBeforeTax); if(!t||!p)return 0.21; return Math.max(0,Math.min(0.35,t/p)); }
function totalDebt(bs){ return parseAV(bs?.shortLongTermDebtTotal) ?? ((parseAV(bs?.longTermDebt)||0)+(parseAV(bs?.shortTermDebt)||0)); }

function calc(pack){
  const qI=pack.income?.quarterlyReports||[], qB=pack.balance?.quarterlyReports||[], qC=pack.cash?.quarterlyReports||[];
  const revenueTTM=sumQ(qI,"totalRevenue") ;
  const ebitdaTTM=sumQ(qI,"ebitda") ?? annual(pack.income?.annualReports,"ebitda");
  const ebitTTM=sumQ(qI,"operatingIncome") ?? annual(pack.income?.annualReports,"operatingIncome");
  const bs=qB[0]||pack.balance?.annualReports?.[0]||{};
  const cash=parseAV(bs?.cashAndCashEquivalentsAtCarryingValue) ?? parseAV(bs?.cashAndShortTermInvestments);
  const debt=totalDebt(bs);
  const equity=parseAV(bs?.totalShareholderEquity) ?? parseAV(bs?.totalStockholderEquity);
  const netDebt=(debt!=null&&cash!=null)? debt-cash:null;
  const netDebtE=(netDebt!=null&&ebitdaTTM)? netDebt/ebitdaTTM:null;
  const ocf=sumQ(qC,"operatingCashflow") ?? annual(pack.cash?.annualReports,"operatingCashflow");
  const capex=sumQ(qC,"capitalExpenditures") ?? annual(pack.cash?.annualReports,"capitalExpenditures");
  const fcf=(ocf!=null&&capex!=null)? ocf-capex:null;
  const fcfMargin=(fcf!=null&&revenueTTM)? (fcf/revenueTTM)*100:null;
  const tax=effTax(pack.income);
  const nopat=(ebitTTM!=null)? ebitTTM*(1-tax):null;
  const invested=(equity!=null&&debt!=null&&cash!=null)? equity+debt-cash:null;
  const roic=(nopat!=null&&invested)? (nopat/invested)*100:null;
  const peg=parseAV(pack.overview?.PEGRatio);
  return{symbol:pack.symbol,name:pack.overview?.Name||pack.symbol,sector:pack.overview?.Sector||"—",marketCap:parseAV(pack.overview?.MarketCapitalization),roic,fcfMargin,netDebtE,revCagr3y:revCagr3Y(pack.income),peg,fcf};
}

function grade(m){
  const a=ragHigher(m.roic,THRESHOLDS.roic);
  const b=ragHigher(m.fcfMargin,THRESHOLDS.fcfMargin);
  const c=ragLower(m.netDebtE,THRESHOLDS.netDebtEbitda);
  const d=ragHigher(m.revCagr3y,THRESHOLDS.revCagr);
  const e=ragLower(m.peg,THRESHOLDS.peg);
  const total=score(a.cls)+score(b.cls)+score(c.cls)+score(d.cls)+score(e.cls);
  const overall= total>=80?{cls:"green",label:"GREEN"}: total>=50?{cls:"amber",label:"AMBER"}:{cls:"red",label:"RED"};
  return{total,overall,a,b,c,d,e};
}

function card(m){
  const g=grade(m);
  const row=(n,v,r)=>`<tr><td>${n}</td><td class="mono">${v}</td><td><span class="badge ${r.cls}">${r.label}</span></td></tr>`;
  return `<div class="card">
    <div class="row">
      <div><div class="ticker">${m.symbol} <span class="k">· ${m.name}</span></div>
      <div class="k">Sector: ${m.sector} · Mkt Cap: <span class="mono">${m.marketCap?fmtMoney(m.marketCap):"N/A"}</span></div></div>
      <div class="row" style="gap:8px;"><span class="badge ${g.overall.cls}">${g.overall.label}</span><span class="badge ${g.overall.cls}">${g.total}/100</span></div>
    </div>
    <table><thead><tr><th>Metric</th><th>Value</th><th>R/A/G</th></tr></thead><tbody>
      ${row("ROIC (approx)",m.roic?fmtNum(m.roic)+"%":"N/A",g.a)}
      ${row("FCF margin (TTM)",m.fcfMargin?fmtNum(m.fcfMargin)+"%":"N/A",g.b)}
      ${row("Net debt / EBITDA (TTM)",m.netDebtE!=null?fmtNum(m.netDebtE):"N/A",g.c)}
      ${row("Revenue CAGR (3Y)",m.revCagr3y?fmtNum(m.revCagr3y)+"%":"N/A",g.d)}
      ${row("PEG",m.peg!=null?fmtNum(m.peg):"N/A",g.e)}
    </tbody></table>
  </div>`;
}

async function run(){
  const t1=$("t1").value.trim().toUpperCase(), t2=$("t2").value.trim().toUpperCase();
  if(!t1||!t2){ $("status").textContent="Enter two tickers."; return; }
  $("go").disabled=true; $("out").innerHTML=""; $("status").textContent="Fetching…";
  try{
    const [p1,p2]=await Promise.all([fetchPack(t1),fetchPack(t2)]);
    const m1=calc(p1), m2=calc(p2);
    $("out").innerHTML=card(m1)+card(m2);
    $("status").textContent="Done.";
  }catch(e){ $("status").textContent="Error: "+e.message; }
  finally{ $("go").disabled=false; }
}
$("go").addEventListener("click", run);
</script>
</body>
</html>
